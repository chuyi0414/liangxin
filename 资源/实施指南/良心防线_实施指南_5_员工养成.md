# 《良心防线》实施指南 - 第五部分：员工养成系统

> 本文档教你实现员工的 Lv1→Lv5 晋升系统。

---

## 一、阶段 4：员工养成

### 目标
- 员工有等级（Lv1~Lv5）
- 花资金可以升级
- 不同等级有不同能力：
  - Lv1：只有普攻，数值弱
  - Lv2：解锁自动技能
  - Lv3：消除负面词条
  - Lv4：添加正面词条
  - Lv5：传奇，可当副官

---

## 二、扩展员工数据

### 2.1 员工运行时数据

**创建文件**：`Assets/Scripts/LiangXin/Data/EmployeeData.cs`

```csharp
using System.Collections.Generic;
using UnityEngine;

namespace LiangXin.Data
{
    /// <summary>
    /// 员工运行时数据（每个员工实例独立）
    /// </summary>
    public class EmployeeData
    {
        // 基础信息
        public int EntityId;          // 在玩法世界中的实体ID
        public string ConfigId;       // 配置ID（如 "F01"）
        public string Name;           // 名字

        // 等级
        public int Level = 1;         // 当前等级（1~5）

        // 词条
        public List<string> NegativeTraits = new List<string>(); // 负面词条
        public List<string> PositiveTraits = new List<string>(); // 正面词条

        // 状态
        public bool IsAutism = false; // 是否"自闭"状态
        public float AutismTimer = 0; // 自闭恢复计时

        // 任务进度（用于 Lv5 觉醒）
        public float QuestProgress = 0f;
        public bool QuestComplete = false;

        // 计算后的属性（受等级和词条影响）
        public int FinalHp;
        public int FinalAtk;
        public float FinalMoveSpeed;
        public float FinalAtkSpeed;
    }

    /// <summary>
    /// 升级消耗配置
    /// </summary>
    public static class UpgradeCost
    {
        // 升到该等级需要的资金
        public static int GetCost(int targetLevel)
        {
            switch (targetLevel)
            {
                case 2: return 50;   // Lv1→Lv2
                case 3: return 100;  // Lv2→Lv3
                case 4: return 200;  // Lv3→Lv4
                case 5: return 500;  // Lv4→Lv5（需要完成任务）
                default: return 0;
            }
        }
    }
}
```

### 2.2 更新 UnitConfig

在 `UnitConfig.cs` 中添加技能相关字段：

```csharp
[Header("技能（Lv2解锁）")]
public string skillId;              // 技能ID
public float skillCooldown = 3f;    // 技能冷却
public string skillDescription;    // 技能描述

[Header("Lv5 传奇大招")]
public string ultimateId;
public string ultimateDescription;
public string questDescription;     // 觉醒任务描述
```

---

## 三、员工管理器升级

更新 `UnitManager.cs`，添加员工实例管理：

```csharp
using System.Collections.Generic;
using UnityEngine;
using LiangXin.Data;
using CYFramework.Runtime.Core;

namespace LiangXin
{
    public class UnitManager : MonoBehaviour
    {
        [Header("单位配置列表")]
        public List<UnitConfig> unitConfigs = new List<UnitConfig>();

        // 配置字典
        private Dictionary<string, UnitConfig> _configDict;

        // 员工实例数据（只管友军）
        private Dictionary<int, EmployeeData> _employees = new Dictionary<int, EmployeeData>();

        private void Awake()
        {
            _configDict = new Dictionary<string, UnitConfig>();
            foreach (var config in unitConfigs)
            {
                if (config != null && !string.IsNullOrEmpty(config.unitId))
                {
                    _configDict[config.unitId] = config;
                }
            }
        }

        public UnitConfig GetConfig(string unitId)
        {
            _configDict.TryGetValue(unitId, out var config);
            return config;
        }

        /// <summary>
        /// 注册新员工
        /// </summary>
        public EmployeeData RegisterEmployee(int entityId, string configId)
        {
            var config = GetConfig(configId);
            if (config == null) return null;

            var data = new EmployeeData
            {
                EntityId = entityId,
                ConfigId = configId,
                Name = config.unitName,
                Level = 1
            };

            // 随机分配一个负面词条（Lv1入职创伤）
            AssignRandomNegativeTrait(data);

            // 计算初始属性
            RecalculateStats(data);

            _employees[entityId] = data;
            return data;
        }

        /// <summary>
        /// 获取员工数据
        /// </summary>
        public EmployeeData GetEmployee(int entityId)
        {
            _employees.TryGetValue(entityId, out var data);
            return data;
        }

        /// <summary>
        /// 升级员工
        /// </summary>
        public bool UpgradeEmployee(int entityId, int gold)
        {
            var emp = GetEmployee(entityId);
            if (emp == null) return false;
            if (emp.Level >= 5) return false;

            int cost = UpgradeCost.GetCost(emp.Level + 1);
            if (gold < cost) return false;

            // 升级
            emp.Level++;
            Debug.Log($"[升级] {emp.Name} 升到 Lv{emp.Level}");

            // Lv3：消除负面词条
            if (emp.Level == 3)
            {
                emp.NegativeTraits.Clear();
                Debug.Log($"[升级] {emp.Name} 的负面词条已消除");

                // 获得一个正面词条
                AssignRandomPositiveTrait(emp);
            }

            // Lv4：再获得一个正面词条
            if (emp.Level == 4)
            {
                AssignRandomPositiveTrait(emp);
            }

            // 重新计算属性
            RecalculateStats(emp);

            return true;
        }

        /// <summary>
        /// 分配随机负面词条
        /// </summary>
        private void AssignRandomNegativeTrait(EmployeeData emp)
        {
            // 简化版：从几个常见负面词条中随机选一个
            string[] traits = { "社交防御", "高压戒断", "自我怀疑", "身心俱疲", "权威恐惧" };
            string trait = traits[Random.Range(0, traits.Length)];
            emp.NegativeTraits.Add(trait);
            Debug.Log($"[词条] {emp.Name} 获得负面词条：{trait}");
        }

        /// <summary>
        /// 分配随机正面词条
        /// </summary>
        private void AssignRandomPositiveTrait(EmployeeData emp)
        {
            string[] traits = { "志同道合", "日进有功", "守望相助", "全情投入", "逆境勇者" };
            string trait = traits[Random.Range(0, traits.Length)];
            emp.PositiveTraits.Add(trait);
            Debug.Log($"[词条] {emp.Name} 获得正面词条：{trait}");
        }

        /// <summary>
        /// 重新计算员工属性
        /// </summary>
        public void RecalculateStats(EmployeeData emp)
        {
            var config = GetConfig(emp.ConfigId);
            if (config == null) return;

            // 基础值 + 等级成长
            int levelBonus = emp.Level - 1;
            emp.FinalHp = config.baseHp + config.hpPerLevel * levelBonus;
            emp.FinalAtk = config.baseAtk + config.atkPerLevel * levelBonus;
            emp.FinalMoveSpeed = config.baseMoveSpeed;
            emp.FinalAtkSpeed = config.baseAtkSpeed;

            // 应用词条效果（简化版）
            foreach (var trait in emp.NegativeTraits)
            {
                ApplyTraitEffect(emp, trait, isNegative: true);
            }
            foreach (var trait in emp.PositiveTraits)
            {
                ApplyTraitEffect(emp, trait, isNegative: false);
            }

            // 同步到玩法世界
            SyncToWorld(emp);
        }

        /// <summary>
        /// 应用词条效果
        /// </summary>
        private void ApplyTraitEffect(EmployeeData emp, string trait, bool isNegative)
        {
            // 简化版：每个词条影响一个属性
            if (isNegative)
            {
                switch (trait)
                {
                    case "社交防御": emp.FinalAtkSpeed *= 0.7f; break;
                    case "高压戒断": emp.FinalAtk = (int)(emp.FinalAtk * 0.5f); break;
                    case "自我怀疑": emp.FinalHp = (int)(emp.FinalHp * 0.8f); break;
                    case "身心俱疲": emp.FinalAtkSpeed *= 0.8f; break;
                    case "权威恐惧": emp.FinalAtk = (int)(emp.FinalAtk * 0.7f); break;
                }
            }
            else
            {
                switch (trait)
                {
                    case "志同道合": emp.FinalAtkSpeed *= 1.3f; break;
                    case "日进有功": emp.FinalAtk = (int)(emp.FinalAtk * 1.2f); break;
                    case "守望相助": emp.FinalHp = (int)(emp.FinalHp * 1.2f); break;
                    case "全情投入": emp.FinalAtkSpeed *= 1.2f; break;
                    case "逆境勇者": emp.FinalAtk = (int)(emp.FinalAtk * 1.5f); break;
                }
            }
        }

        /// <summary>
        /// 同步属性到玩法世界
        /// </summary>
        private void SyncToWorld(EmployeeData emp)
        {
            var world = CYFW.World;
            if (world == null) return;

            if (world.TryGetEntity(emp.EntityId, out var entity))
            {
                entity.MaxHp = emp.FinalHp;
                entity.Hp = Mathf.Min(entity.Hp, entity.MaxHp);
                entity.Attack = emp.FinalAtk;
                entity.MoveSpeed = emp.FinalMoveSpeed;
            }
        }

        /// <summary>
        /// 获取所有员工
        /// </summary>
        public IEnumerable<EmployeeData> GetAllEmployees()
        {
            return _employees.Values;
        }
    }
}
```

---

## 四、升级交互

### 4.1 升级按键

在 `BossController.cs` 的 `HandleCommands()` 中添加：

```csharp
// U - 升级范围内的员工
if (Input.GetKeyDown(KeyCode.U))
{
    UpgradeNearestEmployee();
}

private void UpgradeNearestEmployee()
{
    var employees = GetEmployeesInRange();
    if (employees.Count == 0)
    {
        Debug.Log("范围内没有可升级的员工");
        return;
    }

    // 找等级最低的
    var unitManager = FindObjectOfType<UnitManager>();
    int targetId = -1;
    int lowestLevel = 99;

    foreach (int id in employees)
    {
        var emp = unitManager.GetEmployee(id);
        if (emp != null && emp.Level < 5 && emp.Level < lowestLevel)
        {
            lowestLevel = emp.Level;
            targetId = id;
        }
    }

    if (targetId < 0)
    {
        Debug.Log("范围内没有可升级的员工（都满级了）");
        return;
    }

    // 检查资金
    var emp2 = unitManager.GetEmployee(targetId);
    int cost = UpgradeCost.GetCost(emp2.Level + 1);

    if (Data.Gold < cost)
    {
        Debug.Log($"资金不足！需要 {cost}，当前 {Data.Gold}");
        return;
    }

    // 扣钱升级
    Data.Gold -= cost;
    unitManager.UpgradeEmployee(targetId, cost);
}
```

---

## 五、运行测试

1. 按 Play
2. 杀敌人会掉资金（需要在 `LiangXinGame` 里实现拾取）
3. 走到员工旁边按 U 升级
4. 控制台会显示：
   - "XXX 升到 Lv2"
   - "XXX 的负面词条已消除"（Lv3时）
   - "XXX 获得正面词条：YYY"

---

## 六、下一步

阶段 4 完成了。你现在有：
- ✅ Lv1~Lv5 等级系统
- ✅ 升级消耗资金
- ✅ 负面/正面词条
- ✅ 词条影响属性

**下一阶段（阶段 5）**：完整词条系统
- 完整的词条效果
- 职业专属词条

**阶段 6**：UI 与流程
- 招募界面
- 商店
- 结算画面

请查看 **良心防线_实施指南_6_UI与流程.md**。
