# 《良心防线》实施指南 - 第四部分：波次系统

> 本文档教你实现敌人波次：分波刷新、预警、布阵期。

---

## 一、阶段 3：波次系统

### 目标
- 敌人不再一次性刷出，而是分波次
- 每波开始前有预警（显示进攻方向）
- 有 10 秒布阵期让玩家准备

---

## 二、波次数据结构

### 2.1 波次配置

**创建文件**：`Assets/Scripts/LiangXin/Data/WaveConfig.cs`

```csharp
using System;
using System.Collections.Generic;
using UnityEngine;

namespace LiangXin.Data
{
    /// <summary>
    /// 单波敌人配置
    /// </summary>
    [Serializable]
    public class WaveData
    {
        [Header("波次信息")]
        public int waveNumber;           // 第几波
        public float prepareTime = 10f;  // 布阵时间（秒）

        [Header("敌人配置")]
        public List<WaveSpawn> spawns = new List<WaveSpawn>();
    }

    /// <summary>
    /// 单次刷怪配置
    /// </summary>
    [Serializable]
    public class WaveSpawn
    {
        public string enemyId = "E01";   // 敌人ID
        public int count = 5;            // 数量
        public SpawnDirection direction; // 进攻方向
        public float delay = 0f;         // 延迟（波次开始后多久刷）
    }

    /// <summary>
    /// 进攻方向
    /// </summary>
    /// <summary>
    /// 进攻方向（2D 从屏幕边缘进攻）
    /// </summary>
    public enum SpawnDirection
    {
        Top,     // 上方（屏幕顶部）
        Bottom,  // 下方（屏幕底部）
        Left,    // 左方
        Right    // 右方
    }

    /// <summary>
    /// 波次配置表
    /// </summary>
    [CreateAssetMenu(fileName = "WaveConfig", menuName = "良心防线/波次配置")]
    public class WaveConfig : ScriptableObject
    {
        [Header("地图设置")]
        public float mapRadius = 20f;    // 地图半径（敌人从边缘刷新）

        [Header("波次列表")]
        public List<WaveData> waves = new List<WaveData>();

        /// <summary>
        /// 获取指定方向的生成位置（2D）
        /// </summary>
        public Vector3 GetSpawnPosition(SpawnDirection dir)
        {
            float offset = mapRadius;
            switch (dir)
            {
                case SpawnDirection.Top:    return new Vector3(0, offset, 0);
                case SpawnDirection.Bottom: return new Vector3(0, -offset, 0);
                case SpawnDirection.Left:   return new Vector3(-offset, 0, 0);
                case SpawnDirection.Right:  return new Vector3(offset, 0, 0);
                default: return Vector3.zero;
            }
        }
    }
}
```

### 2.2 创建测试波次配置

1. 在 `Assets/Data/` 创建 `WaveConfig.asset`
2. 右键 → `Create → 良心防线 → 波次配置`
3. 填写测试数据：

**Wave 0（第1波）**：
- Wave Number: 1
- Prepare Time: 10
- Spawns:
  - Enemy Id: E01, Count: 5, Direction: Top, Delay: 0

**Wave 1（第2波）**：
- Wave Number: 2
- Prepare Time: 10
- Spawns:
  - Enemy Id: E01, Count: 5, Direction: Top, Delay: 0
  - Enemy Id: E01, Count: 3, Direction: Right, Delay: 2

---

## 三、波次管理器

**创建文件**：`Assets/Scripts/LiangXin/WaveManager.cs`

```csharp
using System.Collections.Generic;
using UnityEngine;
using CYFramework.Runtime.Core;
using LiangXin.Data;

namespace LiangXin
{
    /// <summary>
    /// 波次状态
    /// </summary>
    public enum WaveState
    {
        Idle,       // 空闲（未开始）
        Preparing,  // 布阵期
        Fighting,   // 战斗中
        Clearing,   // 等待清场
        Complete    // 全部完成
    }

    /// <summary>
    /// 波次管理器
    /// </summary>
    public class WaveManager : MonoBehaviour
    {
        [Header("配置")]
        public WaveConfig waveConfig;

        [Header("调试")]
        public bool autoStart = true;

        // 当前状态
        public WaveState State { get; private set; } = WaveState.Idle;
        public int CurrentWave { get; private set; } = 0;
        public float PrepareTimeLeft { get; private set; } = 0f;

        // 回调
        public System.Action<int, WaveData> OnWaveStart;      // 波次开始
        public System.Action<int> OnWaveComplete;              // 波次完成
        public System.Action OnAllWavesComplete;               // 全部完成
        public System.Action<WaveData> OnPrepareStart;         // 布阵期开始

        // 内部
        private LiangXinGame _game;
        private List<WaveSpawn> _pendingSpawns = new List<WaveSpawn>();
        private int _enemiesAlive = 0;

        private void Start()
        {
            _game = FindObjectOfType<LiangXinGame>();

            if (autoStart)
            {
                // 延迟一点开始，等游戏初始化完成
                CYFW.Timer.Delay(1f, () => StartNextWave());
            }
        }

        private void Update()
        {
            switch (State)
            {
                case WaveState.Preparing:
                    UpdatePreparing();
                    break;
                case WaveState.Fighting:
                    UpdateFighting();
                    break;
                case WaveState.Clearing:
                    UpdateClearing();
                    break;
            }
        }

        /// <summary>
        /// 开始下一波
        /// </summary>
        public void StartNextWave()
        {
            if (waveConfig == null || waveConfig.waves.Count == 0)
            {
                Debug.LogError("没有波次配置！");
                return;
            }

            if (CurrentWave >= waveConfig.waves.Count)
            {
                // 全部完成
                State = WaveState.Complete;
                OnAllWavesComplete?.Invoke();
                Debug.Log("=== 所有波次完成！游戏胜利！===");
                return;
            }

            // 进入布阵期
            var waveData = waveConfig.waves[CurrentWave];
            PrepareTimeLeft = waveData.prepareTime;
            State = WaveState.Preparing;

            // 显示预警
            ShowWaveWarning(waveData);
            OnPrepareStart?.Invoke(waveData);

            Debug.Log($"=== 第 {CurrentWave + 1} 波即将来袭！布阵时间 {PrepareTimeLeft} 秒 ===");
        }

        /// <summary>
        /// 显示波次预警
        /// </summary>
        private void ShowWaveWarning(WaveData wave)
        {
            // 统计各方向兵力
            var directionCounts = new Dictionary<SpawnDirection, int>();

            foreach (var spawn in wave.spawns)
            {
                if (!directionCounts.ContainsKey(spawn.direction))
                    directionCounts[spawn.direction] = 0;
                directionCounts[spawn.direction] += spawn.count;
            }

            // 输出预警
            string warning = $"[预警] 第 {wave.waveNumber} 波：";
            foreach (var kvp in directionCounts)
            {
                string intensity = kvp.Value > 10 ? "大量" : (kvp.Value > 5 ? "中等" : "少量");
                warning += $" {kvp.Key}方向:{intensity}";
            }
            Debug.Log(warning);
        }

        /// <summary>
        /// 布阵期更新
        /// </summary>
        private void UpdatePreparing()
        {
            PrepareTimeLeft -= Time.deltaTime;

            if (PrepareTimeLeft <= 0)
            {
                // 布阵结束，开始战斗
                StartWaveFighting();
            }
        }

        /// <summary>
        /// 开始战斗
        /// </summary>
        private void StartWaveFighting()
        {
            State = WaveState.Fighting;
            var waveData = waveConfig.waves[CurrentWave];

            // 准备刷怪列表
            _pendingSpawns.Clear();
            foreach (var spawn in waveData.spawns)
            {
                _pendingSpawns.Add(spawn);
            }

            // 立即刷出 delay=0 的怪
            SpawnImmediate();

            OnWaveStart?.Invoke(CurrentWave, waveData);
            Debug.Log($"=== 第 {CurrentWave + 1} 波战斗开始！===");
        }

        /// <summary>
        /// 刷出 delay=0 的敌人
        /// </summary>
        private void SpawnImmediate()
        {
            for (int i = _pendingSpawns.Count - 1; i >= 0; i--)
            {
                var spawn = _pendingSpawns[i];
                if (spawn.delay <= 0)
                {
                    SpawnEnemies(spawn);
                    _pendingSpawns.RemoveAt(i);
                }
            }
        }

        /// <summary>
        /// 战斗期更新
        /// </summary>
        private void UpdateFighting()
        {
            // 处理延迟刷怪
            for (int i = _pendingSpawns.Count - 1; i >= 0; i--)
            {
                var spawn = _pendingSpawns[i];
                spawn.delay -= Time.deltaTime;

                if (spawn.delay <= 0)
                {
                    SpawnEnemies(spawn);
                    _pendingSpawns.RemoveAt(i);
                }
            }

            // 如果没有待刷怪物了，进入清场阶段
            if (_pendingSpawns.Count == 0)
            {
                State = WaveState.Clearing;
            }
        }

        /// <summary>
        /// 清场阶段更新
        /// </summary>
        private void UpdateClearing()
        {
            // 统计存活敌人
            _enemiesAlive = CountAliveEnemies();

            if (_enemiesAlive == 0)
            {
                // 波次完成
                OnWaveComplete?.Invoke(CurrentWave);
                Debug.Log($"=== 第 {CurrentWave + 1} 波完成！===");

                CurrentWave++;

                // 短暂休息后开始下一波
                CYFW.Timer.Delay(3f, () => StartNextWave());
                State = WaveState.Idle;
            }
        }

        /// <summary>
        /// 刷出一组敌人
        /// </summary>
        private void SpawnEnemies(WaveSpawn spawn)
        {
            if (_game == null) return;

            Vector3 basePos = waveConfig.GetSpawnPosition(spawn.direction);

            for (int i = 0; i < spawn.count; i++)
            {
                // 在基础位置附近随机偏移（2D）
                Vector3 offset = new Vector3(
                    Random.Range(-3f, 3f),
                    Random.Range(-1f, 1f),
                    0
                );

                _game.SpawnUnit(spawn.enemyId, basePos + offset);
            }

            Debug.Log($"[刷怪] {spawn.direction}方向：{spawn.count} x {spawn.enemyId}");
        }

        /// <summary>
        /// 统计存活敌人数量
        /// </summary>
        private int CountAliveEnemies()
        {
            var world = CYFW.World;
            if (world == null) return 0;

            int count = 0;
            var entities = world.GetAllEntities();
            for (int i = 0; i < entities.Count; i++)
            {
                var e = entities[i];
                if (e.Type == EntityType.Enemy && e.State == EntityState.Active)
                    count++;
            }
            return count;
        }

        /// <summary>
        /// 跳过布阵期（用于调试）
        /// </summary>
        public void SkipPrepare()
        {
            if (State == WaveState.Preparing)
            {
                PrepareTimeLeft = 0;
            }
        }
    }
}
```

---

## 四、集成到游戏

### 4.1 更新 LiangXinGame

把原来的 `StartGame` 里的敌人生成删掉，改用波次管理器：

```csharp
[Header("波次")]
public WaveManager waveManager;

private void StartGame()
{
    // 只生成初始员工，敌人由波次管理器刷新
    SpawnUnit("F01", new Vector3(-3, 0, 0));
    SpawnUnit("F01", new Vector3(3, 0, 0));

    Debug.Log("游戏开始！等待第一波...");
}
```

### 4.2 配置场景

1. 在 `CYFramework` 物体上添加 `WaveManager` 组件
2. 把 `WaveConfig.asset` 拖到 `Wave Config` 字段
3. 勾选 `Auto Start`

---

## 五、运行测试

1. 按 Play
2. 你应该看到：
   - 游戏开始，有 2 个友军
   - 控制台显示预警："第 1 波即将来袭..."
   - 10 秒布阵期倒计时
   - 布阵期结束，敌人从上方刷出
   - 消灭所有敌人后，3 秒后开始第 2 波
   - 第 2 波从两个方向刷怪

---

## 六、下一步

阶段 3 完成了。你现在有：
- ✅ 分波次刷怪
- ✅ 波次预警
- ✅ 布阵期

**下一阶段（阶段 4）**：员工养成系统
- Lv1 → Lv5 晋升
- 每级解锁不同能力
- 资金消耗

请查看 **良心防线_实施指南_5_员工养成.md**。
