# ã€Šè‰¯å¿ƒé˜²çº¿ã€‹å®æ–½æŒ‡å— - ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ‰©å±•å†…å®¹

> æœ¬æ–‡æ¡£æ•™ä½ å¦‚ä½•æŒç»­æ‰©å±•æ¸¸æˆå†…å®¹ï¼šæ›´å¤šèŒä¸šã€SpineåŠ¨ç”»ã€åœ£ç‰©ã€äº‹ä»¶ç­‰ã€‚

---

## ä¸€ã€é˜¶æ®µ 7ï¼šæ‰©å±•å†…å®¹

å½“æ ¸å¿ƒç©æ³•è·‘é€šåï¼Œä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ€è·¯æ‰©å±•å†…å®¹ã€‚

---

## äºŒã€2D èµ„æºå‡çº§è·¯çº¿

ä½ çš„æ¸¸æˆæ˜¯ 2D çš„ï¼Œèµ„æºå‡çº§è·¯çº¿å¦‚ä¸‹ï¼š

```
é˜¶æ®µ 1ï¼šè‰²å—      â†’ ç”¨ä»£ç ç”Ÿæˆçš„çº¯è‰²æ–¹å—ï¼Œå¿«é€ŸéªŒè¯ç©æ³•
é˜¶æ®µ 2ï¼šé™æ€å›¾ç‰‡  â†’ ç”¨ Sprite æ›¿æ¢è‰²å—ï¼Œæœ‰åŸºæœ¬è§†è§‰
é˜¶æ®µ 3ï¼šSpine åŠ¨ç”» â†’ æœ€ç»ˆæ•ˆæœï¼Œæœ‰æ”»å‡»/ç§»åŠ¨/æ­»äº¡åŠ¨ç”»
```

### 2.1 ä»è‰²å—å‡çº§åˆ°å›¾ç‰‡

åªéœ€è¦åœ¨ `UnitConfig` ä¸­å¡«å†™ `sprite` å­—æ®µï¼š

1. å¯¼å…¥ä½ çš„å•ä½å›¾ç‰‡åˆ° `Assets/Art/Units/`
2. ç¡®ä¿å›¾ç‰‡è®¾ç½®ä¸º `Sprite (2D and UI)`
3. åœ¨ `UnitConfig` ä¸­æ‹–å…¥ `Sprite` å­—æ®µ
4. è°ƒæ•´ `spriteScale` æ§åˆ¶å¤§å°

### 2.2 å‡çº§åˆ° Spine åŠ¨ç”»

å½“ä½ å‡†å¤‡å¥½ Spine åŠ¨ç”»åï¼š

**å®‰è£… Spine-Unity Runtime**ï¼š
1. ä¸‹è½½ spine-unity è¿è¡Œæ—¶ï¼šhttps://esotericsoftware.com/spine-unity-download
2. å¯¼å…¥åˆ°é¡¹ç›®

**åˆ›å»º Spine é¢„åˆ¶ä½“**ï¼š

```csharp
// Assets/Scripts/LiangXin/SpineUnitView.cs
using UnityEngine;
using Spine.Unity;

namespace LiangXin
{
    /// <summary>
    /// Spine å•ä½è§†å›¾
    /// </summary>
    public class SpineUnitView : MonoBehaviour
    {
        [Header("Spine ç»„ä»¶")]
        public SkeletonAnimation skeletonAnimation;
        
        [Header("åŠ¨ç”»åç§°")]
        public string idleAnim = "idle";
        public string walkAnim = "walk";
        public string attackAnim = "attack";
        public string dieAnim = "die";
        
        private bool _isDead = false;
        
        /// <summary>
        /// æ’­æ”¾ç©ºé—²åŠ¨ç”»
        /// </summary>
        public void PlayIdle()
        {
            if (_isDead) return;
            skeletonAnimation.AnimationState.SetAnimation(0, idleAnim, true);
        }
        
        /// <summary>
        /// æ’­æ”¾è¡Œèµ°åŠ¨ç”»
        /// </summary>
        public void PlayWalk()
        {
            if (_isDead) return;
            skeletonAnimation.AnimationState.SetAnimation(0, walkAnim, true);
        }
        
        /// <summary>
        /// æ’­æ”¾æ”»å‡»åŠ¨ç”»
        /// </summary>
        public void PlayAttack()
        {
            if (_isDead) return;
            var track = skeletonAnimation.AnimationState.SetAnimation(0, attackAnim, false);
            track.Complete += _ => PlayIdle();
        }
        
        /// <summary>
        /// æ’­æ”¾æ­»äº¡åŠ¨ç”»
        /// </summary>
        public void PlayDie()
        {
            _isDead = true;
            skeletonAnimation.AnimationState.SetAnimation(0, dieAnim, false);
        }
        
        /// <summary>
        /// è®¾ç½®æœå‘ï¼ˆç¿»è½¬ï¼‰
        /// </summary>
        public void SetFacing(float directionX)
        {
            if (directionX != 0)
            {
                transform.localScale = new Vector3(
                    Mathf.Sign(directionX) * Mathf.Abs(transform.localScale.x),
                    transform.localScale.y,
                    transform.localScale.z
                );
            }
        }
    }
}
```

**åœ¨ LiangXinGame ä¸­ä½¿ç”¨**ï¼š

```csharp
// ä¿®æ”¹ CreateView æ–¹æ³•
private void CreateView(int entityId, UnitConfig config)
{
    GameObject view;
    
    if (config.prefab != null)
    {
        // ä½¿ç”¨é¢„åˆ¶ä½“ï¼ˆå¯ä»¥æ˜¯ Spine åŠ¨ç”»ï¼‰
        view = Instantiate(config.prefab);
        
        // å¦‚æœæœ‰ Spine ç»„ä»¶ï¼Œæ’­æ”¾ç©ºé—²åŠ¨ç”»
        var spineView = view.GetComponent<SpineUnitView>();
        if (spineView != null)
        {
            spineView.PlayIdle();
        }
    }
    else
    {
        // é»˜è®¤è‰²å—...
    }
    
    // ... å…¶ä½™ä»£ç 
}
```

**åŒæ­¥åŠ¨ç”»çŠ¶æ€**ï¼š

```csharp
// åœ¨ SyncViews ä¸­æ·»åŠ åŠ¨ç”»åŒæ­¥
private void SyncViews()
{
    foreach (var kvp in _views)
    {
        int entityId = kvp.Key;
        GameObject view = kvp.Value;
        
        if (!_world.TryGetEntity(entityId, out EntityData data)) continue;
        
        var spineView = view.GetComponent<SpineUnitView>();
        if (spineView != null)
        {
            // æ ¹æ®ç§»åŠ¨çŠ¶æ€åˆ‡æ¢åŠ¨ç”»
            Vector3 oldPos = view.transform.position;
            Vector3 newPos = new Vector3(data.Position.x, data.Position.y, 0);
            
            if (Vector3.Distance(oldPos, newPos) > 0.01f)
            {
                spineView.PlayWalk();
                spineView.SetFacing(newPos.x - oldPos.x);
            }
            else
            {
                spineView.PlayIdle();
            }
        }
        
        view.transform.position = new Vector3(data.Position.x, data.Position.y, 0);
    }
}
```

---

## ä¸‰ã€æ·»åŠ æ›´å¤šèŒä¸š

### 3.1 åˆ›å»ºæ–°çš„ UnitConfig

ä»¥ F02 ç½‘çº¦è½¦å¸æœºä¸ºä¾‹ï¼š

1. åœ¨ `Assets/Data/Units/` å³é”®åˆ›å»º `UnitConfig`
2. å¡«å†™æ•°æ®ï¼š
   - Unit Id: `F02`
   - Unit Name: `ç½‘çº¦è½¦å¸æœº`
   - Base Hp: `100`
   - Base Atk: `8`
   - Base Move Speed: `4`ï¼ˆå¼€è½¦å¿«ï¼‰
   - Skill Id: `RemoteLight`
   - Skill Description: `æ¯5ç§’å¼€å¯è¿œå…‰ç¯è‡´ç›²æ•Œäºº`

### 3.2 å®ç°èŒä¸šæŠ€èƒ½

æ¯ä¸ªèŒä¸šçš„ Lv2 æŠ€èƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªæŠ€èƒ½ç³»ç»Ÿæ¥ç®¡ç†ã€‚

**åˆ›å»ºæ–‡ä»¶**ï¼š`Assets/Scripts/LiangXin/Systems/SkillSystem.cs`

```csharp
using System.Collections.Generic;
using CYFramework.Runtime.Core;
using CYFramework.Runtime.Gameplay.Abstraction;
using LiangXin.Data;

namespace LiangXin.Systems
{
    /// <summary>
    /// æŠ€èƒ½ç³»ç»Ÿ
    /// ç®¡ç†å‘˜å·¥çš„è‡ªåŠ¨æŠ€èƒ½ï¼ˆLv2è§£é”ï¼‰
    /// </summary>
    public class SkillSystem : IGameSystem
    {
        public int Priority => 90; // åœ¨AIä¹‹åï¼Œæˆ˜æ–—ä¹‹å‰

        private IGameplayWorld _world;
        private UnitManager _unitManager;

        // æŠ€èƒ½å†·å´
        private Dictionary<int, float> _cooldowns = new Dictionary<int, float>();

        public void Initialize(IGameplayWorld world)
        {
            _world = world;
            _unitManager = UnityEngine.Object.FindObjectOfType<UnitManager>();
        }

        public void Update(float deltaTime)
        {
            if (_unitManager == null) return;

            foreach (var emp in _unitManager.GetAllEmployees())
            {
                // Lv2 ä»¥ä¸Šæ‰æœ‰æŠ€èƒ½
                if (emp.Level < 2) continue;

                UpdateSkill(emp, deltaTime);
            }
        }

        private void UpdateSkill(EmployeeData emp, float deltaTime)
        {
            var config = _unitManager.GetConfig(emp.ConfigId);
            if (config == null || string.IsNullOrEmpty(config.skillId)) return;

            // å†·å´
            if (!_cooldowns.ContainsKey(emp.EntityId))
                _cooldowns[emp.EntityId] = 0f;

            _cooldowns[emp.EntityId] -= deltaTime;

            if (_cooldowns[emp.EntityId] <= 0)
            {
                // é‡Šæ”¾æŠ€èƒ½
                ExecuteSkill(emp, config.skillId);
                _cooldowns[emp.EntityId] = config.skillCooldown;
            }
        }

        private void ExecuteSkill(EmployeeData emp, string skillId)
        {
            switch (skillId)
            {
                case "Charge":
                    // é‡‘ç‰Œéª‘æ‰‹ï¼šå†²é”‹
                    DoChargeSkill(emp);
                    break;
                case "RemoteLight":
                    // ç½‘çº¦è½¦å¸æœºï¼šè¿œå…‰ç¯
                    DoRemoteLightSkill(emp);
                    break;
                // æ·»åŠ æ›´å¤šæŠ€èƒ½...
            }
        }

        private void DoChargeSkill(EmployeeData emp)
        {
            // å‘å‰å†²åˆºï¼Œæ’é£æ²¿é€”æ•Œäºº
            Log.I("Skill", $"{emp.Name} å‘åŠ¨å†²é”‹ï¼");
            // TODO: å®ç°å…·ä½“æ•ˆæœ
        }

        private void DoRemoteLightSkill(EmployeeData emp)
        {
            // æ‰‡å½¢è‡´ç›²
            Log.I("Skill", $"{emp.Name} å¼€å¯è¿œå…‰ç¯ï¼");
            // TODO: å®ç°å…·ä½“æ•ˆæœ
        }

        public void Shutdown() { _cooldowns.Clear(); }
        public void Reset() { _cooldowns.Clear(); }
    }
}
```

### 3.3 æ³¨å†ŒæŠ€èƒ½ç³»ç»Ÿ

åœ¨ `LiangXinGame.Start()` ä¸­ï¼š

```csharp
var world = CYFW.World as GameplayWorldOOP;
world.RegisterSystem(new SkillSystem());
```

---

## å››ã€åœ£ç‰©ç³»ç»Ÿ

### 4.1 åœ£ç‰©æ•°æ®

**åˆ›å»ºæ–‡ä»¶**ï¼š`Assets/Scripts/LiangXin/Data/ArtifactConfig.cs`

```csharp
using UnityEngine;

namespace LiangXin.Data
{
    public enum ArtifactRarity
    {
        Common,   // ç™½
        Rare,     // è“
        Epic,     // ç´«
        Legendary // é‡‘
    }

    [CreateAssetMenu(fileName = "Artifact", menuName = "è‰¯å¿ƒé˜²çº¿/åœ£ç‰©")]
    public class ArtifactConfig : ScriptableObject
    {
        public string artifactId;
        public string artifactName;
        public string description;
        public ArtifactRarity rarity;
        public Sprite icon;

        [Header("æ•ˆæœå‚æ•°")]
        public string effectType;     // æ•ˆæœç±»å‹
        public float effectValue;     // æ•ˆæœæ•°å€¼
    }
}
```

### 4.2 åœ£ç‰©ç®¡ç†å™¨

**åˆ›å»ºæ–‡ä»¶**ï¼š`Assets/Scripts/LiangXin/ArtifactManager.cs`

```csharp
using System.Collections.Generic;
using UnityEngine;
using LiangXin.Data;

namespace LiangXin
{
    public class ArtifactManager : MonoBehaviour
    {
        [Header("æ‰€æœ‰åœ£ç‰©é…ç½®")]
        public List<ArtifactConfig> allArtifacts = new List<ArtifactConfig>();

        // å½“å‰æŒæœ‰çš„åœ£ç‰©
        private List<ArtifactConfig> _ownedArtifacts = new List<ArtifactConfig>();

        public IReadOnlyList<ArtifactConfig> OwnedArtifacts => _ownedArtifacts;

        /// <summary>
        /// è·å¾—åœ£ç‰©
        /// </summary>
        public void AddArtifact(ArtifactConfig artifact)
        {
            _ownedArtifacts.Add(artifact);
            ApplyArtifactEffect(artifact);
            Debug.Log($"[åœ£ç‰©] è·å¾—ï¼š{artifact.artifactName}");
        }

        /// <summary>
        /// åº”ç”¨åœ£ç‰©æ•ˆæœ
        /// </summary>
        private void ApplyArtifactEffect(ArtifactConfig artifact)
        {
            switch (artifact.effectType)
            {
                case "GoldBonus":
                    // èµ„é‡‘è·å–åŠ æˆ
                    break;
                case "HpBonus":
                    // å…¨é˜Ÿè¡€é‡åŠ æˆ
                    break;
                case "AtkSpeedBonus":
                    // å…¨é˜Ÿæ”»é€ŸåŠ æˆ
                    break;
                // æ·»åŠ æ›´å¤šæ•ˆæœ...
            }
        }

        /// <summary>
        /// éšæœºè·å–3ä¸ªåœ£ç‰©ä¾›é€‰æ‹©
        /// </summary>
        public List<ArtifactConfig> GetRandomArtifacts(int count = 3)
        {
            var result = new List<ArtifactConfig>();
            var pool = new List<ArtifactConfig>(allArtifacts);

            for (int i = 0; i < count && pool.Count > 0; i++)
            {
                int idx = Random.Range(0, pool.Count);
                result.Add(pool[idx]);
                pool.RemoveAt(idx);
            }

            return result;
        }
    }
}
```

---

## äº”ã€éšæœºäº‹ä»¶ç³»ç»Ÿ

### 5.1 äº‹ä»¶æ•°æ®

**åˆ›å»ºæ–‡ä»¶**ï¼š`Assets/Scripts/LiangXin/Data/RandomEventConfig.cs`

```csharp
using System;
using System.Collections.Generic;
using UnityEngine;

namespace LiangXin.Data
{
    [Serializable]
    public class EventChoice
    {
        public string text;           // é€‰é¡¹æ–‡æœ¬
        public string effectType;     // æ•ˆæœç±»å‹
        public int goldCost;          // èµ„é‡‘æ¶ˆè€—
        public int conscienceCost;    // è‰¯å¿ƒæ¶ˆè€—
    }

    [CreateAssetMenu(fileName = "RandomEvent", menuName = "è‰¯å¿ƒé˜²çº¿/éšæœºäº‹ä»¶")]
    public class RandomEventConfig : ScriptableObject
    {
        public string eventId;
        public string eventName;
        [TextArea] public string description;

        public List<EventChoice> choices = new List<EventChoice>();
    }
}
```

### 5.2 äº‹ä»¶ç®¡ç†å™¨

**åˆ›å»ºæ–‡ä»¶**ï¼š`Assets/Scripts/LiangXin/RandomEventManager.cs`

```csharp
using System.Collections.Generic;
using UnityEngine;
using CYFramework.Runtime.Core;
using LiangXin.Data;

namespace LiangXin
{
    public class RandomEventManager : MonoBehaviour
    {
        [Header("æ‰€æœ‰äº‹ä»¶")]
        public List<RandomEventConfig> allEvents = new List<RandomEventConfig>();

        [Header("è§¦å‘æ¦‚ç‡")]
        [Range(0, 1)] public float eventChance = 0.3f;

        private WaveManager _waveManager;

        private void Start()
        {
            _waveManager = FindObjectOfType<WaveManager>();

            if (_waveManager != null)
            {
                _waveManager.OnWaveComplete += OnWaveComplete;
            }
        }

        private void OnWaveComplete(int waveIndex)
        {
            // æ¯æ³¢ç»“æŸåï¼Œæœ‰æ¦‚ç‡è§¦å‘äº‹ä»¶
            if (Random.value < eventChance)
            {
                TriggerRandomEvent();
            }
        }

        public void TriggerRandomEvent()
        {
            if (allEvents.Count == 0) return;

            var evt = allEvents[Random.Range(0, allEvents.Count)];
            ShowEventUI(evt);
        }

        private void ShowEventUI(RandomEventConfig evt)
        {
            // æš‚åœæ¸¸æˆ
            CYFW.World?.Pause();

            Debug.Log($"[äº‹ä»¶] {evt.eventName}");
            Debug.Log(evt.description);

            for (int i = 0; i < evt.choices.Count; i++)
            {
                Debug.Log($"  [{i + 1}] {evt.choices[i].text}");
            }

            // TODO: æ‰“å¼€äº‹ä»¶é€‰æ‹©UI
            // CYFW.UI.OpenPanel<EventPanel>(evt);
        }

        public void SelectChoice(RandomEventConfig evt, int choiceIndex)
        {
            if (choiceIndex < 0 || choiceIndex >= evt.choices.Count) return;

            var choice = evt.choices[choiceIndex];

            // æ‰§è¡Œæ•ˆæœ
            ExecuteEffect(choice);

            // æ¢å¤æ¸¸æˆ
            CYFW.World?.Resume();
        }

        private void ExecuteEffect(EventChoice choice)
        {
            var boss = FindObjectOfType<BossController>();
            if (boss == null) return;

            // æ‰£é™¤æ¶ˆè€—
            boss.Data.Gold -= choice.goldCost;
            boss.Data.Conscience -= choice.conscienceCost;

            // æ‰§è¡Œæ•ˆæœ
            switch (choice.effectType)
            {
                case "UpgradeRandomEmployee":
                    // éšæœºå‡çº§ä¸€ä¸ªå‘˜å·¥
                    break;
                case "GainArtifact":
                    // è·å¾—åœ£ç‰©
                    break;
                case "TriggerBattle":
                    // è§¦å‘é¢å¤–æˆ˜æ–—
                    break;
            }

            Debug.Log($"[äº‹ä»¶] é€‰æ‹©äº†ï¼š{choice.text}");
        }

        private void OnDestroy()
        {
            if (_waveManager != null)
            {
                _waveManager.OnWaveComplete -= OnWaveComplete;
            }
        }
    }
}
```

---

## å…­ã€æ‰©å±•æ£€æŸ¥æ¸…å•

æŒ‰ç…§ç­–åˆ’æ¡ˆï¼Œä½ è¿˜å¯ä»¥ç»§ç»­æ·»åŠ ï¼š

### å·²å®ç° âœ…
- [x] åŸºç¡€æˆ˜æ–—
- [x] è€æ¿è§’è‰²
- [x] æ³¢æ¬¡ç³»ç»Ÿ
- [x] å‘˜å·¥å…»æˆï¼ˆLv1~5ï¼‰
- [x] è¯æ¡ç³»ç»Ÿï¼ˆç®€åŒ–ç‰ˆï¼‰
- [x] åŸºç¡€ UI

### å¾…å®ç° ğŸ“‹
- [ ] å®Œæ•´çš„ 50 ç§å‹å†›èŒä¸š
- [ ] å®Œæ•´çš„ 141 ç§æ•Œäºº
- [ ] èŒä¸šä¸“å±è¯æ¡
- [ ] å‰¯å®˜ç³»ç»Ÿ
- [ ] æŒ‡æŒ¥è£…å¤‡å‡çº§
- [ ] åœ£ç‰©ç³»ç»Ÿï¼ˆå®Œæ•´ç‰ˆï¼‰
- [ ] éšæœºäº‹ä»¶ï¼ˆå®Œæ•´ç‰ˆï¼‰
- [ ] å±€å¤–æˆé•¿ï¼ˆå…¬å¸è£…ä¿®ï¼‰
- [ ] éŸ³æ•ˆå’ŒBGM
- [ ] å­˜æ¡£ç³»ç»Ÿ

---

## ä¸ƒã€å¼€å‘å»ºè®®

### 7.1 è¿­ä»£é¡ºåº

1. **å…ˆå‚ç›´åˆ‡**ï¼šç”¨ 2-3 ä¸ªèŒä¸š + 2-3 ç§æ•Œäººï¼ŒæŠŠæ ¸å¿ƒå¾ªç¯è·‘é€š
2. **å†æ¨ªå‘æ‰©**ï¼šé€æ­¥æ·»åŠ æ›´å¤šå†…å®¹
3. **æŒç»­æµ‹è¯•**ï¼šæ¯åŠ ä¸€ä¸ªåŠŸèƒ½å°±æµ‹è¯•ï¼Œé¿å…ç§¯ç´¯é—®é¢˜

### 7.2 æ•°æ®é©±åŠ¨

- å°½é‡æŠŠæ•°æ®æ”¾åœ¨ ScriptableObject é‡Œ
- è¿™æ ·ç­–åˆ’å¯ä»¥ç›´æ¥æ”¹é…ç½®ï¼Œä¸ç”¨æ”¹ä»£ç 
- æ–¹ä¾¿åæœŸåšçƒ­æ›´æ–°

### 7.3 æ¨¡å—åŒ–

- æ¯ä¸ªç³»ç»Ÿç‹¬ç«‹ä¸€ä¸ªæ–‡ä»¶
- ç”¨äº‹ä»¶è§£è€¦æ¨¡å—ä¹‹é—´çš„ä¾èµ–
- æ–¹ä¾¿åæœŸç»´æŠ¤å’Œæ‰©å±•

---

## å…«ã€æ€»ç»“

æ­å–œä½ ï¼è·Ÿç€è¿™ä»½æŒ‡å—ï¼Œä½ å·²ç»å­¦ä¼šäº†ï¼š

1. **é˜¶æ®µ 0**ï¼šæ¡†æ¶åŸºç¡€ - è®© CYFramework è·‘èµ·æ¥
2. **é˜¶æ®µ 1**ï¼šæˆ˜æ–—ç³»ç»Ÿ - å‘˜å·¥ vs æ•Œäºº
3. **é˜¶æ®µ 2**ï¼šè€æ¿è§’è‰² - ç§»åŠ¨ã€æŒ‡æŒ¥
4. **é˜¶æ®µ 3**ï¼šæ³¢æ¬¡ç³»ç»Ÿ - åˆ†æ³¢åˆ·æ€ªã€é¢„è­¦
5. **é˜¶æ®µ 4**ï¼šå‘˜å·¥å…»æˆ - ç­‰çº§ã€è¯æ¡
6. **é˜¶æ®µ 5/6**ï¼šUI ä¸æµç¨‹ - ç•Œé¢ã€äº¤äº’
7. **é˜¶æ®µ 7**ï¼šæ‰©å±•å†…å®¹ - æŠ€èƒ½ã€åœ£ç‰©ã€äº‹ä»¶

æ¥ä¸‹æ¥å°±æ˜¯**æŒç»­å¡«å……å†…å®¹**ï¼ŒæŠŠç­–åˆ’æ¡ˆé‡Œçš„ 50 ä¸ªèŒä¸šã€141 ç§æ•Œäººã€å„ç§åœ£ç‰©å’Œäº‹ä»¶ä¸€ç‚¹ç‚¹åŠ è¿›å»ã€‚

ç¥ä½ å¼€å‘é¡ºåˆ©ï¼ğŸ®
